<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">scripts/urlSharing.js | loopBuilder</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A graphical interface to create looping melodies and rhythms"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="loopBuilder"><meta property="twitter:description" content="A graphical interface to create looping melodies and rhythms"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/cjwit/loopBuilder"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createDrumSampler">createDrumSampler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createSynth">createSynth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-copyUrlToClipboard">copyUrlToClipboard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseLoopFromURL">parseLoopFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaultLoops">defaultLoops</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#classes">Classes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/Box.js~Box.html">Box</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/DrumLoop.js~DrumLoop.html">DrumLoop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/EffectsUI.js~EffectsUI.html">EffectsUI</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/Loop.js~Loop.html">Loop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/PlayButton.js~PlayButton.html">PlayButton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/Row.js~Row.html">Row</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/scripts/Classes/ShareButton.js~ShareButton.html">ShareButton</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">scripts/urlSharing.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { defaultLoops } from &apos;./loops.js&apos;;

/**
 * Parse loop from URL
 */
export function parseLoopFromURL() {
  var loops;
  const url = new URL(document.URL);
  if (url.searchParams != &quot;&quot;) {
    const decodedString = decodeURIComponent(url.searchParams).replace(&quot;loops=&quot;, &quot;&quot;);
    loops = JSON.parse(decodedString)
    console.log(&quot;decoded&quot;, loops)

    // replace long strings to loop data
    loops.melodyLoop.parts = parseLoops(loops.melodyLoop.parts)
    loops.bassLoop.parts = parseLoops(loops.bassLoop.parts)
    loops.drumLoop.parts = parseLoops(loops.drumLoop.parts)

  } else {
    loops = defaultLoops;
    console.log(&quot;using default loops&quot;, loops)
  }
  return loops;
}

/**
 * Replace long binary strings with an array of loops
 * @param {string} string 
 */
function parseLoops(string) {
  // split loop string into substrings of a given length
  var strings = string.split(/(.{8})/).filter(s =&gt; { return s.length &gt; 0; });
  var result = [];
  strings.forEach(currentPart =&gt; {
    currentPart = currentPart.split(&quot;&quot;);
    var parsedPart = [];
    currentPart.forEach(value =&gt; {
      parsedPart.push(Number(value));
    })
    result.push(parsedPart);
  })
  return result;
}

/**
 * Create a URL and copy it to the clipboard
 */
export function copyUrlToClipboard() {
  var loops = getRowData();
  // create url string
  var url = new URL(document.URL);
  var urlString = url.host + url.pathname + &quot;?loops=&quot; + encodeURIComponent(JSON.stringify(loops));
  console.log(urlString)

  // create dummy object for clipboard copy
  var urlStringDomHolder = document.createElement(&quot;input&quot;);
  document.getElementById(&quot;shareButton&quot;).appendChild(urlStringDomHolder);
  urlStringDomHolder.value = urlString;
  urlStringDomHolder.select();
  document.execCommand(&quot;copy&quot;);
}

/**
 * Get current sequencer state by scanning DOM objects
 */
function getRowData() {
  // get melody rows
  var melodyRows = &quot;&quot;;
  var bassRows = &quot;&quot;;
  var drumRows = &quot;&quot;;

  var rows = document.getElementsByClassName(&quot;row-of-boxes&quot;);
  for (let i = 0; i &lt; rows.length; i++) {
    var rowData = getLoopArray(rows[i]);
    if (i &lt; 15) { melodyRows += rowData }
    else if (i &lt; 30) { bassRows += rowData }
    else { drumRows += rowData }
  }
  
  // get tempo
  var tempo = document.getElementById(&quot;bpm-span&quot;).innerText;

  // get scale (coming later);
  var scale = &quot;dorian&quot;;

  // get effects values
  var melodyEffectValueSpans = document.getElementById(&quot;melodyEffects&quot;).getElementsByClassName(&quot;effectValue&quot;);
  var bassEffectValueSpans = document.getElementById(&quot;bassEffects&quot;).getElementsByClassName(&quot;effectValue&quot;);
  var melodyEffectLevels = [melodyEffectValueSpans[0].innerText, melodyEffectValueSpans[1].innerText]
  var bassEffectLevels = [bassEffectValueSpans[0].innerText, bassEffectValueSpans[1].innerText]

  // compile result
  var result = {
    melodyLoop: {
      scale: scale + &quot;Melody&quot;,
      parts: melodyRows,
      effectLevels: melodyEffectLevels
    },
    bassLoop: {
      scale: scale + &quot;Bass&quot;,
      parts: bassRows,
      effectLevels: bassEffectLevels
    },
    drumLoop: {
      scale: &quot;drumSet&quot;,
      parts: drumRows
    },
    tempo: tempo
  }

  return result;
}

/**
 * Create array of 1s and 0s based on current box status in a row
 * @param {HTMLElement} row
 * @return {array}
 */
function getLoopArray(row) {
  let rowData = &quot;&quot;;
  // iterate through each box in the row
  for (let j = 1; j &lt; row.childNodes.length; j++) {
    // convert row box status to a long binary string
    let filled = row.childNodes[j].classList.contains(&quot;filled-box&quot;)
    filled ? rowData += &quot;1&quot; : rowData += &quot;0&quot;;
  }
  return rowData;
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
